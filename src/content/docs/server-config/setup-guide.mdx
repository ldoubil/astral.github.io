---
title: æ­å»ºæŒ‡å—
description: å­¦ä¹ å¦‚ä½•æ­å»ºè‡ªå·±çš„ Astral æœåŠ¡å™¨
sidebar:
  order: 2
---

import AstralServer from '../../../components/AstralServer.astro';
import { Steps, Aside, Card, CardGrid, Tabs, TabItem } from '@astrojs/starlight/components';

# ğŸ—ï¸ æœåŠ¡å™¨æ­å»ºæŒ‡å—

æ­å»ºè‡ªå·±çš„ Astral æœåŠ¡å™¨å¯ä»¥è·å¾—æ›´å¥½çš„æ§åˆ¶æƒã€éšç§ä¿æŠ¤å’Œæ€§èƒ½è¡¨ç°ã€‚

## ğŸ¯ æ­å»ºæœåŠ¡å™¨çš„ä¼˜åŠ¿

<CardGrid>
  <Card title="ğŸ”’ å®Œå…¨æ§åˆ¶" icon="shield">
    å®Œå…¨æŒæ§æœåŠ¡å™¨é…ç½®ã€ç”¨æˆ·ç®¡ç†å’Œå®‰å…¨ç­–ç•¥
  </Card>
  <Card title="ğŸš€ æ›´å¥½æ€§èƒ½" icon="rocket">
    ä¸“å±èµ„æºï¼Œæ— éœ€ä¸å…¶ä»–ç”¨æˆ·å…±äº«å¸¦å®½
  </Card>
  <Card title="ğŸ›¡ï¸ éšç§ä¿æŠ¤" icon="lock">
    æ•°æ®ä¸ç»è¿‡ç¬¬ä¸‰æ–¹ï¼Œç¡®ä¿ä¼ä¸šæ•°æ®å®‰å…¨
  </Card>
  <Card title="ğŸ¯ å®šåˆ¶åŒ–" icon="star">
    æ ¹æ®å…·ä½“éœ€æ±‚ä¼˜åŒ–é…ç½®å’ŒåŠŸèƒ½
  </Card>
</CardGrid>

## ğŸ–¥ï¸ ç³»ç»Ÿè¦æ±‚

### æœ€ä½é…ç½®

| ç»„ä»¶ | æœ€ä½è¦æ±‚ | æ¨èé…ç½® |
|------|----------|----------|
| **CPU** | 1 æ ¸å¿ƒ | 2+ æ ¸å¿ƒ |
| **å†…å­˜** | 512MB | 2GB+ |
| **å­˜å‚¨** | 10GB | 50GB+ SSD |
| **ç½‘ç»œ** | 10Mbps | 100Mbps+ |
| **ç³»ç»Ÿ** | Linux/Windows | Ubuntu 20.04+ |

### ç½‘ç»œè¦æ±‚

- ğŸŒ **å…¬ç½‘ IP**ï¼šå›ºå®šæˆ–åŠ¨æ€å…¬ç½‘ IP åœ°å€
- ğŸ”“ **ç«¯å£å¼€æ”¾**ï¼šé»˜è®¤ç«¯å£ 11010ï¼ˆå¯è‡ªå®šä¹‰ï¼‰
- ğŸ›¡ï¸ **é˜²ç«å¢™é…ç½®**ï¼šå…è®¸æŒ‡å®šç«¯å£çš„ TCP/UDP æµé‡
- âš¡ **å¸¦å®½å……è¶³**ï¼šä¸Šä¸‹è¡Œå¸¦å®½æ»¡è¶³ç”¨æˆ·éœ€æ±‚

## ğŸš€ å¿«é€Ÿå¼€å§‹

### è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬

<AstralServer />

### Docker éƒ¨ç½²æ–¹å¼

<Tabs>
  <TabItem label="Docker Compose">
    **åˆ›å»º docker-compose.yml æ–‡ä»¶**ï¼š

    ```yaml
    version: '3.8'
    services:
      astral-server:
        image: easytier/easytier:latest
        container_name: astral-server
        restart: unless-stopped
        ports:
          - "11010:11010/tcp"
          - "11010:11010/udp"
        volumes:
          - ./config:/app/config
          - ./logs:/app/logs
        environment:
          - EASYTIER_CONFIG_FILE=/app/config/config.toml
        command: >
          easytier-core
          --config-file /app/config/config.toml
          --multi-thread
    ```

    **å¯åŠ¨æœåŠ¡**ï¼š
    ```bash
    # åˆ›å»ºå¿…è¦ç›®å½•
    mkdir -p config logs

    # å¯åŠ¨æœåŠ¡
    docker-compose up -d

    # æŸ¥çœ‹æ—¥å¿—
    docker-compose logs -f
    ```
  </TabItem>

  <TabItem label="Docker å‘½ä»¤">
    **ç›´æ¥ä½¿ç”¨ Docker å‘½ä»¤**ï¼š

    ```bash
    # æ‹‰å–é•œåƒ
    docker pull easytier/easytier:latest

    # åˆ›å»ºé…ç½®ç›®å½•
    mkdir -p /opt/astral/{config,logs}

    # è¿è¡Œå®¹å™¨
    docker run -d \
      --name astral-server \
      --restart unless-stopped \
      -p 11010:11010/tcp \
      -p 11010:11010/udp \
      -v /opt/astral/config:/app/config \
      -v /opt/astral/logs:/app/logs \
      easytier/easytier:latest \
      easytier-core --config-file /app/config/config.toml
    ```
  </TabItem>
</Tabs>

## âš™ï¸ è¯¦ç»†é…ç½®

### æœåŠ¡å™¨é…ç½®æ–‡ä»¶

åˆ›å»º `config.toml` é…ç½®æ–‡ä»¶ï¼š

```toml
# æœåŠ¡å™¨åŸºæœ¬é…ç½®
[server]
# ç›‘å¬åœ°å€å’Œç«¯å£
listen_addr = "0.0.0.0:11010"

# å¯ç”¨çš„åè®®
protocols = ["tcp", "udp"]

# æœ€å¤§è¿æ¥æ•°
max_connections = 1000

# è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
connection_timeout = 300

# ç½‘ç»œé…ç½®
[network]
# è™šæ‹Ÿç½‘ç»œåœ°å€æ®µ
network_cidr = "10.126.126.0/24"

# å¯ç”¨ NAT ç©¿é€
enable_nat_traversal = true

# å¯ç”¨ç«¯å£æ˜ å°„
enable_port_mapping = true

# æ€§èƒ½ä¼˜åŒ–
[performance]
# å¯ç”¨å¤šçº¿ç¨‹
enable_multi_thread = true

# ç¼“å†²åŒºå¤§å°ï¼ˆKBï¼‰
buffer_size = 64

# å¯ç”¨å‹ç¼©
enable_compression = true

# å®‰å…¨é…ç½®
[security]
# å¯ç”¨åŠ å¯†
enable_encryption = true

# åŠ å¯†ç®—æ³•
encryption_algorithm = "aes-256-gcm"

# æœ€å¤§æˆ¿é—´æ•°
max_rooms = 100

# æ—¥å¿—é…ç½®
[logging]
# æ—¥å¿—çº§åˆ«ï¼šdebug, info, warn, error
log_level = "info"

# æ—¥å¿—æ–‡ä»¶è·¯å¾„
log_file = "/app/logs/server.log"

# å¯ç”¨æ—¥å¿—è½®è½¬
enable_log_rotation = true

# æœ€å¤§æ—¥å¿—æ–‡ä»¶å¤§å°ï¼ˆMBï¼‰
max_log_size = 100
```

### é˜²ç«å¢™é…ç½®

<Tabs>
  <TabItem label="Ubuntu/Debian">
    ```bash
    # å®‰è£… ufw
    sudo apt update
    sudo apt install ufw

    # å¼€æ”¾ SSH ç«¯å£ï¼ˆé‡è¦ï¼ï¼‰
    sudo ufw allow ssh

    # å¼€æ”¾ Astral ç«¯å£
    sudo ufw allow 11010/tcp
    sudo ufw allow 11010/udp

    # å¯ç”¨é˜²ç«å¢™
    sudo ufw enable

    # æŸ¥çœ‹çŠ¶æ€
    sudo ufw status
    ```
  </TabItem>

  <TabItem label="CentOS/RHEL">
    ```bash
    # å®‰è£… firewalld
    sudo yum install firewalld
    sudo systemctl start firewalld
    sudo systemctl enable firewalld

    # å¼€æ”¾ç«¯å£
    sudo firewall-cmd --permanent --add-port=11010/tcp
    sudo firewall-cmd --permanent --add-port=11010/udp

    # é‡è½½é…ç½®
    sudo firewall-cmd --reload

    # æŸ¥çœ‹çŠ¶æ€
    sudo firewall-cmd --list-all
    ```
  </TabItem>

  <TabItem label="Windows">
    **ä½¿ç”¨ Windows é˜²ç«å¢™**ï¼š

    <Steps>
    1. æ‰“å¼€"Windows å®‰å…¨ä¸­å¿ƒ"
    2. é€‰æ‹©"é˜²ç«å¢™å’Œç½‘ç»œä¿æŠ¤"
    3. ç‚¹å‡»"é«˜çº§è®¾ç½®"
    4. åˆ›å»ºæ–°çš„å…¥ç«™è§„åˆ™ï¼š
       - è§„åˆ™ç±»å‹ï¼šç«¯å£
       - åè®®ï¼šTCP å’Œ UDP
       - ç«¯å£ï¼š11010
       - æ“ä½œï¼šå…è®¸è¿æ¥
    5. åˆ›å»ºå¯¹åº”çš„å‡ºç«™è§„åˆ™
    </Steps>
  </TabItem>
</Tabs>

## ğŸ”§ é«˜çº§é…ç½®

### è´Ÿè½½å‡è¡¡è®¾ç½®

å¯¹äºé«˜å¹¶å‘åœºæ™¯ï¼Œå¯ä»¥é…ç½®å¤šä¸ªæœåŠ¡å™¨å®ä¾‹ï¼š

```yaml
# nginx è´Ÿè½½å‡è¡¡é…ç½®
upstream astral_backend {
    least_conn;
    server 127.0.0.1:11010 weight=3;
    server 127.0.0.1:11011 weight=2;
    server 127.0.0.1:11012 weight=1;
}

server {
    listen 80;
    server_name astral.yourdomain.com;
    
    location / {
        proxy_pass http://astral_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }
}
```

### SSL/TLS åŠ å¯†

ä¸ºæœåŠ¡å™¨å¯ç”¨ HTTPS æ”¯æŒï¼š

```bash
# ä½¿ç”¨ Let's Encrypt è·å–è¯ä¹¦
sudo apt install certbot
sudo certbot certonly --standalone -d astral.yourdomain.com

# æ›´æ–° nginx é…ç½®
server {
    listen 443 ssl http2;
    server_name astral.yourdomain.com;
    
    ssl_certificate /etc/letsencrypt/live/astral.yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/astral.yourdomain.com/privkey.pem;
    
    # SSL å®‰å…¨é…ç½®
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
}
```

### æ•°æ®åº“é›†æˆ

å¯¹äºä¼ä¸šçº§éƒ¨ç½²ï¼Œå¯ä»¥é›†æˆæ•°æ®åº“å­˜å‚¨ç”¨æˆ·å’Œä¼šè¯ä¿¡æ¯ï¼š

```sql
-- åˆ›å»ºç”¨æˆ·è¡¨
CREATE TABLE users (
    id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    email VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_login TIMESTAMP,
    is_active BOOLEAN DEFAULT TRUE
);

-- åˆ›å»ºæˆ¿é—´è¡¨
CREATE TABLE rooms (
    id INT PRIMARY KEY AUTO_INCREMENT,
    room_id VARCHAR(50) UNIQUE NOT NULL,
    room_name VARCHAR(100) NOT NULL,
    password_hash VARCHAR(255),
    owner_id INT,
    max_members INT DEFAULT 20,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    is_active BOOLEAN DEFAULT TRUE,
    FOREIGN KEY (owner_id) REFERENCES users(id)
);

-- åˆ›å»ºä¼šè¯è¡¨
CREATE TABLE sessions (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT,
    room_id INT,
    ip_address VARCHAR(45),
    connected_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    disconnected_at TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (room_id) REFERENCES rooms(id)
);
```

## ğŸ“Š ç›‘æ§å’Œç»´æŠ¤

### ç³»ç»Ÿç›‘æ§

**ä½¿ç”¨ Prometheus + Grafana**ï¼š

```yaml
# prometheus.yml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'astral-server'
    static_configs:
      - targets: ['localhost:11010']
    metrics_path: '/metrics'
    scrape_interval: 5s
```

**ç›‘æ§æŒ‡æ ‡**ï¼š
- ğŸ“Š **è¿æ¥æ•°é‡**ï¼šå½“å‰æ´»è·ƒè¿æ¥æ•°
- â±ï¸ **å“åº”æ—¶é—´**ï¼šæœåŠ¡å™¨å“åº”å»¶è¿Ÿ
- ğŸ’¾ **èµ„æºä½¿ç”¨**ï¼šCPUã€å†…å­˜ã€ç½‘ç»œä½¿ç”¨ç‡
- ğŸ”„ **é”™è¯¯ç‡**ï¼šè¿æ¥å¤±è´¥å’Œé”™è¯¯ç»Ÿè®¡

### æ—¥å¿—ç®¡ç†

```bash
# é…ç½® logrotate
sudo vim /etc/logrotate.d/astral

# å†…å®¹å¦‚ä¸‹ï¼š
/opt/astral/logs/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 astral astral
    postrotate
        docker restart astral-server > /dev/null 2>&1 || true
    endscript
}
```

### è‡ªåŠ¨åŒ–è¿ç»´

**å¥åº·æ£€æŸ¥è„šæœ¬**ï¼š

```bash
#!/bin/bash
# astral-health-check.sh

ASTRAL_HOST="localhost"
ASTRAL_PORT="11010"
LOG_FILE="/var/log/astral-health.log"

# æ£€æŸ¥ç«¯å£æ˜¯å¦å¼€æ”¾
if nc -z $ASTRAL_HOST $ASTRAL_PORT; then
    echo "$(date): Astral server is healthy" >> $LOG_FILE
else
    echo "$(date): Astral server is down, restarting..." >> $LOG_FILE
    docker restart astral-server
    
    # å‘é€å‘Šè­¦é‚®ä»¶
    echo "Astral server on $HOSTNAME is down and has been restarted" | \
    mail -s "Astral Server Alert" admin@yourdomain.com
fi
```

**è®¾ç½®å®šæ—¶ä»»åŠ¡**ï¼š
```bash
# æ·»åŠ åˆ° crontab
crontab -e

# æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
*/5 * * * * /opt/astral/scripts/health-check.sh
```

## ğŸš¨ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜è§£å†³

<Tabs>
  <TabItem label="è¿æ¥é—®é¢˜">
    **æœåŠ¡å™¨æ— æ³•è¿æ¥**ï¼š

    1. **æ£€æŸ¥ç«¯å£å¼€æ”¾**ï¼š
       ```bash
       # æ£€æŸ¥ç«¯å£ç›‘å¬
       netstat -tlnp | grep 11010
       
       # æµ‹è¯•ç«¯å£è¿é€šæ€§
       telnet localhost 11010
       ```

    2. **æ£€æŸ¥é˜²ç«å¢™è§„åˆ™**ï¼š
       ```bash
       # Ubuntu
       sudo ufw status
       
       # CentOS
       sudo firewall-cmd --list-all
       ```

    3. **æŸ¥çœ‹æœåŠ¡æ—¥å¿—**ï¼š
       ```bash
       # Docker å®¹å™¨æ—¥å¿—
       docker logs astral-server
       
       # ç³»ç»ŸæœåŠ¡æ—¥å¿—
       journalctl -u astral-server
       ```
  </TabItem>

  <TabItem label="æ€§èƒ½é—®é¢˜">
    **æœåŠ¡å™¨æ€§èƒ½å·®**ï¼š

    1. **æ£€æŸ¥ç³»ç»Ÿèµ„æº**ï¼š
       ```bash
       # CPU å’Œå†…å­˜ä½¿ç”¨
       top
       htop
       
       # ç½‘ç»œæµé‡
       iftop
       nethogs
       
       # ç£ç›˜ I/O
       iotop
       ```

    2. **ä¼˜åŒ–é…ç½®**ï¼š
       - å¢åŠ ç¼“å†²åŒºå¤§å°
       - å¯ç”¨å¤šçº¿ç¨‹å¤„ç†
       - è°ƒæ•´è¿æ¥è¶…æ—¶æ—¶é—´
       - å¯ç”¨å‹ç¼©ä¼ è¾“

    3. **æ‰©å®¹èµ„æº**ï¼š
       - å‡çº§æœåŠ¡å™¨é…ç½®
       - å¢åŠ å¸¦å®½
       - ä½¿ç”¨ SSD å­˜å‚¨
  </TabItem>
</Tabs>

### å¤‡ä»½å’Œæ¢å¤

**é…ç½®å¤‡ä»½**ï¼š
```bash
#!/bin/bash
# backup-config.sh

BACKUP_DIR="/opt/astral/backups"
DATE=$(date +%Y%m%d_%H%M%S)

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# å¤‡ä»½é…ç½®æ–‡ä»¶
tar -czf $BACKUP_DIR/astral-config-$DATE.tar.gz \
    /opt/astral/config/ \
    /opt/astral/logs/ \
    /etc/docker/compose/astral/

# ä¿ç•™æœ€è¿‘30å¤©çš„å¤‡ä»½
find $BACKUP_DIR -name "astral-config-*.tar.gz" -mtime +30 -delete
```

**æ•°æ®æ¢å¤**ï¼š
```bash
#!/bin/bash
# restore-config.sh

BACKUP_FILE=$1

if [ -z "$BACKUP_FILE" ]; then
    echo "Usage: $0 <backup-file>"
    exit 1
fi

# åœæ­¢æœåŠ¡
docker-compose down

# æ¢å¤é…ç½®
tar -xzf $BACKUP_FILE -C /

# é‡å¯æœåŠ¡
docker-compose up -d
```

---

<Aside type="caution" title="å®‰å…¨æé†’">
- å®šæœŸæ›´æ–°æœåŠ¡å™¨ç³»ç»Ÿå’Œè½¯ä»¶
- ä½¿ç”¨å¼ºå¯†ç å’Œå¯†é’¥è®¤è¯
- é…ç½®é€‚å½“çš„é˜²ç«å¢™è§„åˆ™
- å®šæœŸå¤‡ä»½é‡è¦é…ç½®å’Œæ•°æ®
- ç›‘æ§æœåŠ¡å™¨å®‰å…¨æ—¥å¿—
</Aside>
